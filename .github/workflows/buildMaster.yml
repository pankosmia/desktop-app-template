name: Master Build
# builds windows, linux and Mac

permissions:
  actions: write
  contents: read

on:
  workflow_dispatch:
    inputs:
      os:
        description: 'OS'
        required: true
        type: choice
        options:
          - all
          - windows
          - linux
          - macos
        default: all

      server_type:
        description: 'Server type'
        required: true
        type: choice
        options:
          - release
          - debug
        default: release

# set run name from input so the run appears with that name (no API call needed)
run-name: Master Build - ${{ inputs.os }} - ${{ inputs.server_type }} server

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - run: |
          echo "OS is ${{ inputs.os }}"
          echo "Server type is ${{ inputs.server_type }}"

  build-macos-intel:
    name: Build on macOS Intel64 (x64)
    if: ${{ inputs.os == 'all' || inputs.os == 'macos' }}
    uses: ./.github/workflows/macos-build-steps.yml
    with:
      runner: macos-15-intel
      delay_seconds: 1
      server_type: ${{ inputs.server_type }}

  build-macos-arm:
    name: Build on macOS ARM64 (Apple Silicon)
    if: ${{ inputs.os == 'all' || inputs.os == 'macos' }}
    uses: ./.github/workflows/macos-build-steps.yml
    with:
      runner: macos-14
      delay_seconds: 600
      server_type: ${{ inputs.server_type }}

  build-windows:
    name: Build on Windows x64
    if: ${{ inputs.os == 'all' || inputs.os == 'windows' }}
    uses: ./.github/workflows/windows-build-steps.yml
    with:
      runner: windows-2025
      server_type: ${{ inputs.server_type }}

  build-linux:
    name: Build on Linux x64
    if: ${{ inputs.os == 'all' || inputs.os == 'linux' }}
    uses: ./.github/workflows/linux-build-steps.yml
    with:
      runner: ubuntu-22.04
      server_type: ${{ inputs.server_type }}

  finalize:
    needs: [build-macos-intel, build-macos-arm, build-windows, build-linux]
    runs-on: ubuntu-latest
    if: always()
    steps:
      # Turn off re-runs
      - name: No re-runs please
        run: |
         if [ "$GITHUB_RUN_ATTEMPT" -gt 1 ]; then
            echo "No re-runs. They use the commit SHA and git ref of the original event that triggered the workflow run. However, that does not extend to client and resource repos which may expect a more recent panksomia-web."
            echo "Start a new workflow run instead."
            exit 1
          else
            echo "NOT a re-run"
          fi

      # Check build status (allow skipped when OS not selected)
      - name: Check build status
        run: |
          check () {
            job="$1"
            result="$2"

            case "$result" in
              success) echo "$job: success" ;;
              skipped) echo "$job: skipped" ;;
              failure|cancelled|timed_out) echo "$job: failed ($result)"; exit 1 ;;
              *) echo "$job: failed (unknown result: $result)"; exit 1 ;;
            esac
          }

          check "macos-intel"  "${{ needs.build-macos-intel.result }}"
          check "macos-arm"    "${{ needs.build-macos-arm.result }}"
          check "windows"      "${{ needs.build-windows.result }}"
          check "linux"        "${{ needs.build-linux.result }}"

          echo "Selected builds completed successfully"

# TODO
#  create-universal-binary:
#    needs: [build-macos-intel, build-macos-arm]
#    runs-on: macos-latest
#    steps:
#      - name: Checkout repository
#        uses: actions/checkout@v3
#
#      - name: Download Intel artifact
#        uses: actions/download-artifact@v4
#        with:
#          name: ${{ needs.build-macos-intel.outputs.zip-name }}
#          path: ./downloads/intel
#
#      - name: Download ARM artifact
#        uses: actions/download-artifact@v4
#        with:
#          name: ${{ needs.build-macos-arm.outputs.zip-name }}
#          path: ./downloads/arm
#
#      - name: Create universal binary
#        run: |
#          # Your script to combine the Intel and ARM builds
#          echo "Creating universal binary from Intel and ARM artifacts"